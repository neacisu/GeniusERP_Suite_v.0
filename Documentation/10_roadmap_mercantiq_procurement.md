# 10 · Roadmap Mercantiq Procurement – **versiune upgradată** (workeri + integrare suita)

> **Scop:** să implementăm **Mercantiq Procurement** ca modulul responsabil de fluxul **Procure-to-Pay** în suita GeniusERP – cu integrare profundă de **workeri** (match.ai, pdf.render, notify.slack, email.send) și interoperabilitate **suite & stand‑alone** cu **iWMS**, **Sales**, **Accounting** și ecosistemul complet.
> **Stack fix:** React 19 + Vite 5 Federation + MUI 6 + Tailwind 3 (UI), NestJS 11 (API), Python 3.13 (workers), RMQ 3.14 + Redis 7 (bus), Terraform + Helmfile + ArgoCD (deploy). Respectă convențiile de nume evenimente `module.ctx.event`. Folosește doar căile canonice `standalone/mercantiq/...`.
> **Gate F2 ➜ F3:** flux **Procure‑to‑Pay** E2E < 3 min, evenimente confirmate; SLO API p95 < 250 ms, error\_rate < 1 %.

**Fluxul Procure-to-Pay complet:** RFQ (Request for Quote) → Quote → Purchase Order (PO) → Goods Received Note (GRN) → Three-Way Match (3WM) → Invoice Processing cu automatizare maximă și integrări AI pentru sugestii furnizori și detectarea anomaliilor.

**Workeri integrați (disponibili azi în flotă):**
`match.ai` (sugestii furnizori și anomalii 3WM), `pdf.render` (generare PDF comenzi), `email.send` (notificare furnizori), `notify.slack` (alerte echipe), `ai.classify` (clasificare cereri), `forecast` (predicții cerere)
**Date & securitate:** Multi‑tenant PG 17 + MinIO per tenant (SSE‑C AES‑256‑GCM), Redis per tenant; JWT RS256 cu claims `tid`,`whid`,`scp`,`role`; RLS strictă pe `tid/whid`.
**Observabilitate:** Prometheus metrics, Tempo traces end‑to‑end (browser→API→RMQ→worker), dashboards P2P & alerte.

---

## Cum să folosești această documentație

Această documentație reprezintă un roadmap detaliat pentru dezvoltarea aplicației stand-alone **Mercantiq Procurement** (Procure-to-Pay). Lista de pași este organizată sub formă de obiecte JSON, fiecare element corespunzând unei etape concrete de implementare.

**Parcurge pașii în ordine:** Fiecare element JSON are un câmp step (indexul pasului 330-416) și descrie o acțiune ce trebuie realizată. Pașii sunt organizați logic de la scaffolding la deployment complet.

**Înțelege structura câmpurilor:** Fiecare obiect conține câmpuri esențiale – scope indică sub‑sistemul sau componenta vizată, context oferă detalii despre starea proiectului înainte de acest pas, task descrie în mod imperativ acțiunea de efectuat, dirs precizează directoarele/proiectele afectate, constraints enumeră reguli sau condiții ce trebuie respectate, iar output descrie pe scurt rezultatul așteptat.

**Respectă constraints:** Câmpul constraints include cerințe stricte precum respectarea convențiilor de commit (Conventional Commits), rularea linter‑elor, integrarea cu External Secrets pentru credențiale, și condiții de performanță și securitate.

**Navighează după scope:** Pașii sunt grupați logic prin câmpul scope (ex. "procurement‑scaffold", "procurement‑db‑*", "procurement‑service‑*", "procurement‑ui‑*"). Poți prioritiza sau delega anumite sub‑sisteme pe baza acestei clasificări.

## 1) Pre‑condiții & Scope

* **Gate F1 trecut**: Shell vizibil (3 widget‑uri), Admin Core & Worker Registry verzi.
* **Event‑Bus v1** și naming `<module>.<ctx>.<event>` deja stabilite; hook `scripts/lint-rmq.sh` obligatoriu.
* **Multitenancy & date**: PostgreSQL 17 (cluster per tenant, schema per modul), MinIO per tenant, Redis per tenant, **RLS pe `tid/whid/mid`**.
* **Worker Fleet** disponibil: `match.ai`, `pdf.render`, `email.send`, `notify.slack`, `ai.classify`, `forecast`.
* **Stack fix**: React 19 + Vite 5 Federation + MUI 6 + Tailwind 3 (UI), NestJS 11 (API), Python 3.13 (workeri), RabbitMQ 3.14 + Redis 7 (bus/queue), IaC: Terraform + Helmfile + Argo CD.
* **Module paralele**: Mercantiq Sales & iWMS v3 în dezvoltare paralelă pentru integrări evenimente.

## 2) Bounded‑Context & Interfețe

### **Entități principale**
* **Supplier**: furnizori pentru cereri de ofertă și comenzi cu rating și istoric colaborare
* **RFQ** (Request for Quote): cereri de ofertă cu linii detaliate și termene limită  
* **Quote**: oferte primite de la furnizori cu valori și termene de valabilitate
* **PurchaseOrder**: comenzi de achiziție cu aprobări și tracking status
* **GRN** (Goods Received Note): recepții marfă din depozit cu cantități verificate
* **Invoice**: facturi furnizor pentru procesul de Three‑Way Match
* **ThreeWayMatch**: rezultate comparație PO vs GRN vs Invoice cu detectarea discrepanțelor

### **Evenimente publicate**
* **`procurement.rfq.created`**: cerere de ofertă nouă creată cu detalii și deadline
* **`procurement.po.approved`**: comandă de achiziție aprobată și trimisă către furnizor
* **`procurement.grn.posted`**: recepție marfă confirmată în depozit
* **`procurement.3wm.flagged`**: discrepanță detectată în Three‑Way Match (>2%)

### **Evenimente consumate**
* **`wms.grn.posted`**: confirmarea recepției din iWMS pentru actualizare status PO
* **`match.ai.suggestion`**: recomandare furnizor optim pentru RFQ nou
* **`pdf.render.done`**: PDF comandă generat și salvat în MinIO
* **`sales.order.created`**: nou order pentru declanșare achiziții de stoc insuficient

### **Workeri integrați**

**Fleet existentă:**
* `match.ai` - sugestii furnizori optimi și detectarea anomaliilor în 3WM
* `pdf.render` - generare PDF comenzi cu template branduit per tenant
* `email.send` - notificare furnizori cu comenzi și actualizări status
* `notify.slack` - alerte echipe pentru aprobări, discrepanțe și milestone‑uri
* `ai.classify` - clasificare automată cereri și predicție categorii achiziții
* `forecast` - predicții cerere pe baza istoricului și trend‑urilor sezoniere

## 3) Arhitectura Aplicației

### **Mercantiq Procurement Overview**

Mercantiq Procurement devine motorul principal pentru fluxul Procure‑to‑Pay din suita GeniusERP, cu automatizare completă și inteligență artificială integrată. Aplicația acoperă:

- **Flux P2P complet**: de la cererea de ofertă la plata furnizorului cu automatizare maximă
- **AI‑powered insights**: sugestii furnizori, detectarea anomaliilor, predicții cerere
- **Three‑Way Match automat**: comparație inteligentă PO vs GRN vs Invoice cu praguri configurabile
- **Integrare depozit**: sincronizare în timp real cu iWMS pentru recepții și stocuri
- **Aprobare workflow**: circuite de aprobare flexibile pe baza valorilor și categoriilor

### **Integrarea cu Ecosistemul**

Prin integrările extinse, modulul conectează:
- **iWMS v3**: recepții automate → actualizare comenzi + 3WM trigger
- **Sales**: stoc insuficient → RFQ automat pentru reaprovizionare
- **Accounting (F3)**: facturi aprobate → transfer în modulul financiar
- **Worker Registry**: orchestrare inteligentă a tuturor serviciilor AI

### **Fluxul Procure‑to‑Pay & KPI**

**Eficiență E2E**: RFQ→PO→GRN→3WM→Invoice se finalizează cu succes, cu alertă la discrepanțe >2%.
**Performanță**: Timp mediu P2P <3 minute, API p95 <250ms, error rate <1%.
**Observabilitate**: Traces end‑to‑end, dashboards P2P dedicat, 8+ alerte predefinite.

## 4) Securitate & RBAC

* Scopes Keycloak `procurement/*` cu roluri granulare (buyer, approver, procurement‑admin)
* Guard JWT RS256 + RLS pe toate tabelele pentru izolare multi‑tenant
* ABAC la UI cu permisiuni fine pe funcționalități (aprobare PO, modificare furnizori)
* Rate limiting și throttling anti‑abuz pe endpoint‑urile critice
* Audit trail pentru toate acțiunile critice cu export CSV semnat

## 5) Observabilitate

* OTel traces end‑to‑end (browser→API→workers) cu propagare context și corelare
* Prometheus metrics (HTTP + business: RFQ count, PO approval rate, 3WM flags)
* Dashboard dedicat Procure‑to‑Pay cu KPI‑uri cheie și SLO monitoring
* Alerting pentru praguri: RFQ OPEN >14 zile, PO fără recepție >7 zile, queue lag
* Audit logs pentru acțiuni critice cu căutare și export securizat

## 6) Criterii de Acceptanță F2

* **Flux P2P complet**: RFQ → Quote → PO → GRN → 3WM → Invoice în <3 minute
* **AI integration**: sugestii furnizori funcționale și anomaly detection la 3WM
* **Performance**: API p95 <250ms, error rate <1%, trace‑uri complete end‑to‑end
* **Automatizare**: workflow‑uri de aprobare, notificări și sincronizare iWMS
* **Integrări**: evenimente publicate/consumate conform specificației Event‑Bus
* **Three‑Way Match**: detectarea automată a discrepanțelor >2% cu alerting
* **Workeri activi**: PDF, email, Slack, AI matching și clasificare

## 7) Structura Implementării

### **Interval F2**: 330‑416 (87 pași)
- **Effort**: 5‑6 săptămâni dezvoltare (incluzând integrări complexe)
- **Scop**: Mercantiq Procurement complet cu toate fluxurile P2P
- **Modul**: `mercantiq‑procurement` (frontend + api + workers integration)
- **Dependențe**: F1 Core Platform + F2 Base Workers + iWMS integration

## 8) CursorAI Prompts (Mercantiq Procurement 330–416)

> **Format obligatoriu:** `step`, `scope`, `context`, `task`, `dirs`, `constraints`, `output` (identic F0/F1). **Nu hard‑coda secrete**, folosește External Secrets. **Căi canonice** `standalone/mercantiq/**` (lint‑paths blochează vechile `/apps/...`).

```json
[
  {"step":330,"scope":"procurement-scaffold","context":"Modul stand-alone Mercantiq Procurement inexistent.","task":"Rulează scriptul `core/scripts/create-module.ts` pentru a genera aplicația stand-alone Mercantiq Procurement cu frontend React și API NestJS.","dirs":["/standalone/mercantiq/apps/procurement/"],"constraints":"Aplică tag-urile Nx `module:procurement, layer:{frontend,api}`; commit 'feat(procurement): scaffold module'.","output":"schelet Procurement"},
  {"step":331,"scope":"procurement-db-suppliers","context":"Baza de date Mercantiq Procurement goală.","task":"Creează migration TypeORM pentru tabelul `suppliers` (coloane: id, name, email, rating, etc.) cu cheie primară (tid, id) și coloană tenant id (`tid`).","dirs":["/standalone/mercantiq/apps/procurement/api/src/migrations/"],"constraints":"Fără date duplicate; `id` serial pe tenant.","output":"tabel suppliers"},
  {"step":332,"scope":"procurement-db-rfq","context":"Tabel suppliers creat (pas 331).","task":"Creează migration pentru tabelul `rfq` (request-for-quote): coloane id RFQ, referință la supplier (opțional), status (OPEN/CLOSED), termen limită, etc.; include `tid` în cheia primară.","dirs":["/standalone/mercantiq/apps/procurement/api/src/migrations/"],"constraints":"FK opțională spre suppliers; status default 'OPEN'.","output":"tabel rfq"},
  {"step":333,"scope":"procurement-db-rfq-lines","context":"Tabel rfq creat (pas 332).","task":"Creează migration pentru tabelul `rfq_lines` cu coloane: rfq_id, linie_nr, descriere produs/serviciu, cantitate, unitate, etc.; include `tid` și referință la rfq.","dirs":["/standalone/mercantiq/apps/procurement/api/src/migrations/"],"constraints":"FK către rfq (rfq_id). Cheie compusă (rfq_id, linie_nr).","output":"tabel rfq_lines"},
  {"step":334,"scope":"procurement-db-quotes","context":"Tabel rfq_lines creat (pas 333).","task":"Creează migration pentru tabelul `quotes` (oferte furnizor) cu coloane: quote_id, rfq_id, supplier_id, valoare, valabilitate, etc.; include `tid` și referințe către rfq și supplier.","dirs":["/standalone/mercantiq/apps/procurement/api/src/migrations/"],"constraints":"FK către rfq și supplier; supplier poate lipsi dacă ofertă anonimă (ex. ad-hoc).","output":"tabel quotes"},
  {"step":335,"scope":"procurement-db-po","context":"Tabel quotes creat (pas 334).","task":"Creează migration pentru tabelul `purchase_orders` cu coloane: po_id, rfq_id (opțional), supplier_id, status (PENDING/APPROVED), data_emitere, total, etc.; include `tid` și `whid` dacă se aplică depozit țintă.","dirs":["/standalone/mercantiq/apps/procurement/api/src/migrations/"],"constraints":"FK opțională la rfq; status default PENDING.","output":"tabel purchase_orders"},
  {"step":336,"scope":"procurement-db-po-lines","context":"Tabel purchase_orders creat (pas 335).","task":"Creează migration pentru tabelul `po_lines` cu coloane: po_id, linie_nr, descriere, cantitate, preț_unitar, etc.; include `tid` și referință la purchase_orders.","dirs":["/standalone/mercantiq/apps/procurement/api/src/migrations/"],"constraints":"FK spre purchase_orders; cheie compusă (po_id, linie_nr).","output":"tabel po_lines"},
  {"step":337,"scope":"procurement-db-grn","context":"Tabel po_lines creat (pas 336).","task":"Creează migration pentru tabelul `grn` (goods received note) cu coloane: grn_id, po_id, data_recepție, cantitate_totală, etc.; include `tid` și `whid`, plus referință la purchase_orders.","dirs":["/standalone/mercantiq/apps/procurement/api/src/migrations/"],"constraints":"FK spre purchase_orders; unicitate: 1 GRN per PO.","output":"tabel grn"},
  {"step":338,"scope":"procurement-db-invoices","context":"Tabel grn creat (pas 337).","task":"Creează migration pentru tabelul `invoices` (facturi furnizor) cu coloane: inv_id, po_id, număr_factură, data, sumă_totală; include `tid` și referință la purchase_orders.","dirs":["/standalone/mercantiq/apps/procurement/api/src/migrations/"],"constraints":"FK spre purchase_orders; stochează sumă pentru 3WM.","output":"tabel invoices"},
  {"step":339,"scope":"procurement-db-3wm","context":"Tabel invoices creat (pas 338).","task":"Creează migration pentru tabelul `three_way_match` cu coloane: match_id, po_id, status_match (OK/FLAGGED), diferență_valoare (%), etc.; include `tid` și referință la purchase_orders.","dirs":["/standalone/mercantiq/apps/procurement/api/src/migrations/"],"constraints":"FK spre purchase_orders; se completează după recepție & factură.","output":"tabel three_way_match"},
  {"step":340,"scope":"procurement-db-constraints","context":"Tabele de bază create (pas 331–339).","task":"Adaugă constrângeri de integritate suplimentare: indexuri pentru cheile străine (ex. rfq_lines.rfq_id, po_lines.po_id) și index pe `tid` la toate tabelele, pentru performanța accesului multi-tenant.","dirs":["/standalone/mercantiq/apps/procurement/api/src/migrations/"],"constraints":"Constrângeri incluse în migration; verifică că PK compuse includ `tid`.","output":"indexuri adăugate"},
  {"step":341,"scope":"procurement-db-unique-quote","context":"Tabel quotes definit (pas 334).","task":"Implementează constrângere UNIQUE `(supplier_id, rfq_id)` pe tabelul `quotes` pentru a preveni două oferte de la același furnizor la același RFQ.","dirs":["/standalone/mercantiq/apps/procurement/api/src/migrations/"],"constraints":"Migration cu `UNIQUE(supplier_id, rfq_id)`.","output":"unicat ofertă/furnizor/RFQ"},
  {"step":342,"scope":"procurement-rls-main","context":"Tabele Procurement create.","task":"Activează Row-Level Security (RLS) pe tabelele principale (`suppliers`, `rfq`, `quotes`, `purchase_orders`, `invoices`, `three_way_match`) cu politica standardizată: `tid = current_setting('app.tid') AND (whid = current_setting('app.whid') OR whid IS NULL)`.","dirs":["/standalone/mercantiq/apps/procurement/api/src/migrations/"],"constraints":"Politici PG standard conform suita; RLS ON by default; include whid isolation.","output":"RLS pe tabele tenant cu politica standard"},
  {"step":343,"scope":"procurement-rls-lines","context":"RLS setat pe entități principale (pas 342).","task":"Activează RLS pe tabelele de linii (`rfq_lines`, `po_lines`) cu aceeași politică standardizată: `tid = current_setting('app.tid') AND (whid = current_setting('app.whid') OR whid IS NULL)`.","dirs":["/standalone/mercantiq/apps/procurement/api/src/migrations/"],"constraints":"Utilizează policy standard identică cu tabelele părinte; consistență RLS.","output":"RLS pe linii Procurement cu politica standard"},
  {"step":344,"scope":"procurement-rls-validation","context":"RLS setat cu politica standard pe toate tabelele.","task":"Adaugă teste comprehensive pentru politica RLS standardizată: verifică că politica `tid = current_setting('app.tid') AND (whid = current_setting('app.whid') OR whid IS NULL)` funcționează corect pe toate tabelele Procurement, inclusiv scenarii multi-warehouse.","dirs":["/standalone/mercantiq/apps/procurement/api/tests/"],"constraints":"CI fail hard; testează cross-tenant isolation; testează whid NULL scenarios.","output":"RLS standard validat complet"},
  {"step":345,"scope":"procurement-entities","context":"Schemele de date definite (pas 331–339).","task":"Definește entitățile TypeORM corespunzătoare (clase TS): Supplier, RFQ, RFQLine, Quote, PurchaseOrder, POLine, GRN, Invoice, ThreeWayMatch, mapând coloanele și relațiile (OneToMany, ManyToOne).","dirs":["/standalone/mercantiq/apps/procurement/api/src/entities/"],"constraints":"Respectă numele coloanelor ca în DB; include decoratori pentru relații (e.g. RFQ are multiple RFQLine).","output":"entități ORM Procurement"},
  {"step":346,"scope":"procurement-module-config","context":"Entități ORM definite (pas 345).","task":"Configurează modulul NestJS Procurement API: importă `TypeOrmModule.forFeature([...entities])`, declară serviciile și controller-ele, asigură injection-ul pentru repository-urile entităților.","dirs":["/standalone/mercantiq/apps/procurement/api/src/"],"constraints":"Adaugă modul Procurement în importurile aplicației core dacă este necesar; izolează logica specifică modulului.","output":"modul Procurement configurat (API Nest)"},
  {"step":347,"scope":"procurement-dto-supplier","context":"Validare input lipsă pentru Supplier.","task":"Definește un DTO `CreateSupplierDto` cu `class-validator` pentru crearea de furnizori (nume obligatoriu, email valid, etc.).","dirs":["/standalone/mercantiq/apps/procurement/api/src/dto/"],"constraints":"Fără câmpuri opționale nesecurizate; validează formatul de email.","output":"DTO Supplier definit"},
  {"step":348,"scope":"procurement-dto-rfq","context":"Validare input lipsă pentru RFQ.","task":"Definește `CreateRFQDto` și `AddRFQLineDto` pentru crearea unui RFQ nou cu liniile sale: câmpuri obligatorii (descrieri, cantități), validare tip numeric pentru cantități.","dirs":["/standalone/mercantiq/apps/procurement/api/src/dto/"],"constraints":"Folosește `IsNotEmpty`, `IsNumber` etc. pentru validare.","output":"DTO RFQ (cerere ofertă)"},
  {"step":349,"scope":"procurement-dto-quote","context":"Validare input lipsă pentru Quote.","task":"Definește `CreateQuoteDto` pentru oferta furnizor: câmpuri (rfq_id, supplier_id, valoare, valabilitate_zile), include validări (valoare > 0, valabilitate > 0).","dirs":["/standalone/mercantiq/apps/procurement/api/src/dto/"],"constraints":"Verifică (în service) că rfq_id și supplier_id există în DB; status RFQ = OPEN.","output":"DTO Quote (ofertă)"},
  {"step":350,"scope":"procurement-dto-invoice","context":"Validare input lipsă pentru Invoice.","task":"Definește `RecordInvoiceDto` pentru înregistrarea unei facturi de furnizor: câmpuri (po_id, număr, dată, sumă_totală), validare sumă > 0 și format dată.","dirs":["/standalone/mercantiq/apps/procurement/api/src/dto/"],"constraints":"Număr factură string max 50 de caractere; dată ISO string.","output":"DTO Invoice"},
  {"step":351,"scope":"procurement-service-supplier","context":"Entitate Supplier definită.","task":"Implementează `SupplierService` pentru operații CRUD de bază (creare, listare) asupra furnizorilor, folosind repository-ul TypeORM corespunzător.","dirs":["/standalone/mercantiq/apps/procurement/api/src/services/"],"constraints":"Nu permite duplicarea numelui exact; loghează acțiunile la nivel info.","output":"serviciu Supplier (CRUD)"},
  {"step":352,"scope":"procurement-service-rfq","context":"Entități RFQ și RFQLine definite.","task":"Implementează `RFQService` cu logica de creare RFQ nou: salvează RFQ și liniile asociate (RFQLine) într-o tranzacție; setează status implicit OPEN.","dirs":["/standalone/mercantiq/apps/procurement/api/src/services/"],"constraints":"Utilizează `QueryRunner` pentru tranzacție multi-repo; dacă eșuează vreo inserție, face rollback.","output":"serviciu creare RFQ"},
  {"step":353,"scope":"procurement-service-add-quote","context":"Ofertele se adaugă la RFQ existent.","task":"Extinde `RFQService` sau creează `QuoteService` pentru a permite adăugarea unei oferte (`Quote`) la un RFQ deschis: validează că RFQ are status=OPEN și că furnizorul nu are deja ofertă înregistrată.","dirs":["/standalone/mercantiq/apps/procurement/api/src/services/"],"constraints":"Dacă RFQ este CLOSED sau ofertă duplicat, aruncă eroare; actualizează timestamp la adăugare.","output":"serviciu adăugare Quote"},
  {"step":354,"scope":"procurement-service-accept-quote","context":"RFQ cu oferte primite.","task":"Implementează logica de acceptare a unei oferte: selectează un `Quote`, marchează RFQ ca CLOSED și generează o comandă de achiziție (`PurchaseOrder`) pe baza ofertei acceptate (include liniile și prețurile din ofertă).","dirs":["/standalone/mercantiq/apps/procurement/api/src/services/"],"constraints":"Setează furnizorul câștigător pe PO; RFQ status devine CLOSED; celelalte oferte pot fi marcate ca neacceptate (ex. un flag).","output":"serviciu acceptare ofertă"},
  {"step":355,"scope":"procurement-service-po","context":"Comandă de achiziție generată (pas 354).","task":"Implementează `PurchaseOrderService` pentru gestionarea comenzilor: metodă de aprobare PO (schimbă status din PENDING în APPROVED) și calculează totalul PO (suma liniilor) la aprobare.","dirs":["/standalone/mercantiq/apps/procurement/api/src/services/"],"constraints":"Calculează `total` PO din liniile sale; nu permite aprobare dacă nu are linii.","output":"serviciu aprobare PO"},
  {"step":356,"scope":"procurement-service-grn","context":"Recepție marfă (iWMS trimite eveniment).","task":"Adaugă în `PurchaseOrderService` funcția `markReceived(poId, qty)` apelată la recepție: setează indicator de recepționat pe PO și creează înregistrare GRN cu cantitatea recepționată.","dirs":["/standalone/mercantiq/apps/procurement/api/src/services/"],"constraints":"Dacă cantitatea recepționată < cantitatea comandată, permite multiple GRN (recepție parțială). Altfel marchează PO ca COMPLET RECEIVED.","output":"serviciu recepție marfă (PO)"},
  {"step":357,"scope":"procurement-service-invoice","context":"Factură furnizor primită.","task":"Implementează `InvoiceService.recordInvoice(poId, data)` care salvează factura primită pentru PO dat: înregistrează sumă și detaliile facturii, apoi declanșează verificarea **3-Way Match**.","dirs":["/standalone/mercantiq/apps/procurement/api/src/services/"],"constraints":"Permite o singură factură per PO; leagă Invoice de PO via po_id (FK).","output":"serviciu înregistrare factură"},
  {"step":358,"scope":"procurement-service-3wm","context":"3-Way Match necesar (PO aprobat, recepție și factură primite).","task":"Integrează logica de **3-Way Match**: compară cantitatea și valoarea din PO, GRN și Invoice. Dacă diferența valorică > 2%, marchează match-ul ca FLAGGED; altfel OK.","dirs":["/standalone/mercantiq/apps/procurement/api/src/services/"],"constraints":"Diferența calculată în procente față de valoarea PO; actualizează tabelul `three_way_match`.","output":"status 3WM calculat (OK sau FLAGGED)"},
  {"step":359,"scope":"procurement-controller-supplier","context":"Serviciu Supplier disponibil (pas 351).","task":"Implementează `SupplierController` NestJS cu endpoint-uri REST pentru listarea furnizorilor (**GET /suppliers**) și crearea unui furnizor nou (**POST /suppliers**) folosind SupplierService.","dirs":["/standalone/mercantiq/apps/procurement/api/src/controllers/"],"constraints":"Protejat cu JWT (scope procurement:*); returnează 201 la creare.","output":"endpoint CRUD Supplier"},
  {"step":360,"scope":"procurement-controller-rfq","context":"Serviciu RFQ disponibil (pas 352).","task":"Implementează `RFQController` cu endpoint-uri **GET /rfqs** (listează RFQ-urile curente, cu filtrare opțională după status) și **POST /rfqs** (creează un RFQ nou cu linii incluse).","dirs":["/standalone/mercantiq/apps/procurement/api/src/controllers/"],"constraints":"Validează DTO la intrare; setează header Location la crearea unui RFQ.","output":"endpoint listare + creare RFQ"},
  {"step":361,"scope":"procurement-controller-quote","context":"Serviciu Quote disponibil (pas 353).","task":"Implementează endpoint-ul **POST** `/rfqs/{id}/quotes` în RFQController pentru a adăuga o ofertă la RFQ-ul specificat (folosind CreateQuoteDto).","dirs":["/standalone/mercantiq/apps/procurement/api/src/controllers/"],"constraints":"Verifică existența RFQ-ului {id} și că este OPEN; returnează 201 sau eroare 400 dacă RFQ-ul e închis.","output":"endpoint adăugare Quote"},
  {"step":362,"scope":"procurement-controller-accept","context":"Serviciu acceptare ofertă disponibil (pas 354).","task":"Implementează endpoint-ul **POST** `/rfqs/{id}/accept` care primește în body un supplier/quote_id și acceptă oferta respectivă, creând PO-ul asociat (folosind RFQService).","dirs":["/standalone/mercantiq/apps/procurement/api/src/controllers/"],"constraints":"Doar dacă RFQ este OPEN; răspunde cu detaliile PO creat.","output":"endpoint acceptare ofertă"},
  {"step":363,"scope":"procurement-controller-po","context":"Serviciu PurchaseOrder disponibil (pas 355).","task":"Implementează `PurchaseOrderController` cu endpoint-uri **GET /purchase-orders** (listează PO-urile, opțional filtru status) și **GET /purchase-orders/{id}** (detalii PO, incl. linii).","dirs":["/standalone/mercantiq/apps/procurement/api/src/controllers/"],"constraints":"Include date despre recepție și factură dacă există; protejat JWT.","output":"endpoint listare + detalii PO"},
  {"step":364,"scope":"procurement-controller-approve","context":"Serviciu aprobare PO disponibil (pas 355).","task":"Implementează endpoint-ul **PATCH** `/purchase-orders/{id}/approve` care marchează PO ca APPROVED și declanșează logica aferentă (ex. emitere eveniment bus).","dirs":["/standalone/mercantiq/apps/procurement/api/src/controllers/"],"constraints":"Doar pentru utilizatori cu rol de aprobare; returnează 200 la succes sau 403 dacă nu are permisiune.","output":"endpoint aprobare PO"},
  {"step":365,"scope":"procurement-controller-invoice","context":"Serviciu înregistrare factură disponibil (pas 357).","task":"Implementează endpoint-ul **POST** `/purchase-orders/{id}/invoice` pentru a adăuga detaliile facturii furnizor la PO-ul dat (folosind RecordInvoiceDto și InvoiceService).","dirs":["/standalone/mercantiq/apps/procurement/api/src/controllers/"],"constraints":"Permite un singur invoice per PO; validează că PO este RECEIVED înainte de a înregistra factura (altfel 409).","output":"endpoint înregistrare Invoice"},
  {"step":366,"scope":"procurement-event-rfq","context":"RFQ nou creat (pas 360).","task":"Publică evenimentul **`procurement.rfq.created`** în Event-Bus imediat ce un RFQ este creat, incluzând detalii (rfq_id, tid, total_linii, deadline).","dirs":["/standalone/mercantiq/apps/procurement/api/src/events/"],"constraints":"Folosește SDK TS pentru publish; nu blochează request-ul curent.","output":"event RFQ creat (bus)"},
  {"step":367,"scope":"procurement-event-po-approved","context":"PO aprobat (pas 364).","task":"Publică evenimentul **`procurement.po.approved`** când o comandă de achiziție este aprobată, conținând id PO, tid, whid și suma totală.","dirs":["/standalone/mercantiq/apps/procurement/api/src/events/"],"constraints":"Eveniment emis o singură dată per PO; respectă schema definită în docs/event-bus.","output":"event PO aprobat (bus)"},
  {"step":368,"scope":"procurement-event-grn","context":"Recepție marfă (pas 356, iWMS notifică recepția).","task":"Publică evenimentul **`procurement.grn.posted`** după înregistrarea recepției (GRN) pentru un PO, conținând id PO, cantitate recepționată, timestamp.","dirs":["/standalone/mercantiq/apps/procurement/api/src/events/"],"constraints":"Declanșat doar la recepția completă (sau ultima recepție dacă e parțială); nu duplică evenimentul iWMS.","output":"event GRN postat (bus)"},
  {"step":369,"scope":"procurement-event-3wm","context":"Diferențe identificate la 3WM (pas 358).","task":"Publică evenimentul **`procurement.3wm.flagged`** dacă rezultatul 3-Way Match indică o discrepanță peste pragul acceptat (ex. > 2%). Include detalii: po_id, procent diferență, tip (cantitate/valoare).","dirs":["/standalone/mercantiq/apps/procurement/api/src/events/"],"constraints":"Emite doar la FLAGGED; dacă match-ul e OK nu trimite nimic.","output":"event 3WM flag (alert)"},
  {"step":370,"scope":"procurement-subscribe-wms","context":"Integrare iWMS (recepție).","task":"Consumă evenimentul **`wms.grn.posted`** emis de modulul iWMS (recepție în depozit) pentru a actualiza statusul PO corespunzător: apelează `PurchaseOrderService.markReceived` și creează entry GRN.","dirs":["/standalone/mercantiq/apps/procurement/api/src/listeners/"],"constraints":"Mapează `wms.grn.posted` la PO ID; gestionează cazul de recepție parțială (cantitate < comandată).","output":"PO marcat ca recepționat"},
  {"step":371,"scope":"procurement-subscribe-ai","context":"RFQ creat (event bus).","task":"Consumă evenimentul **`match.ai.suggestion`** (worker AI) care furnizează o recomandare de furnizor pentru un RFQ nou: actualizează RFQ cu furnizorul sugerat (sau atribuie un câmp `suggested_supplier_id`).","dirs":["/standalone/mercantiq/apps/procurement/api/src/listeners/"],"constraints":"Doar pentru RFQ OPEN fără ofertă încă; nu suprascrie dacă user-ul alege alt furnizor.","output":"recomandare furnizor salvată (AI)"},
  {"step":372,"scope":"procurement-subscribe-pdf","context":"Generare PDF PO cerută.","task":"Consumă evenimentul **`pdf.render.done`** emis de worker-ul `pdf.render` când PDF-ul pentru PO a fost generat: actualizează PO cu link-ul către PDF (salvat în MinIO).","dirs":["/standalone/mercantiq/apps/procurement/api/src/listeners/"],"constraints":"Salvează URL securizat (SSE-C) în tabelul PurchaseOrder; accesibil pentru download ulterior.","output":"PO cu PDF atașat (link)"},
  {"step":373,"scope":"procurement-worker-pdf","context":"Comandă aprobată (pas 364).","task":"La aprobarea unui PO, declanșează generarea PDF-ului comenzii: trimite cerere către worker-ul `pdf.render` cu template PO (include linii, total, info furnizor).","dirs":["/standalone/mercantiq/apps/procurement/api/src/services/"],"constraints":"Folosește coada `pdf.render` via RabbitMQ; payload include PO ID și un JSON cu detalii.","output":"cerere PDF trimisă către worker"},
  {"step":374,"scope":"procurement-worker-email","context":"PDF PO generat (pas 372).","task":"După generarea PDF-ului, declanșează trimiterea către furnizor: apelează worker-ul `email.send` cu adresa furnizorului și link-ul securizat al comenzii (PDF) ca atașament.","dirs":["/standalone/mercantiq/apps/procurement/api/src/services/"],"constraints":"Template email: subiect 'Purchase Order #{id}' + atașament PDF; nu expune link public (folosește token semnat).","output":"notificare email furnizor (PO)"},
  {"step":375,"scope":"procurement-worker-slack","context":"PO aprobat (pas 364).","task":"Trimite notificare Slack internă (via worker `notify.slack`) când o comandă este aprobată: mesaj sumar (PO #{id}, furnizor, valoare) pe canalul `#procurement`.","dirs":["/standalone/mercantiq/apps/procurement/api/src/services/"],"constraints":"Folosește webhook configurat; nu include date sensibile în mesaj.","output":"alertă Slack PO aprobat"},
  {"step":376,"scope":"procurement-ui-suppliers-static","context":"UI Procurement creat (pas 330).","task":"Creează pagina `SuppliersPage` în frontend-ul Procurement cu layout inițial: tabel (coloane: Nume, Email, Rating) și buton de adăugare furnizor.","dirs":["/standalone/mercantiq/apps/procurement/frontend/src/pages/"],"constraints":"Folosește MUI DataGrid pentru listă; Tailwind pentru spațiere și stilizare.","output":"pagina Suppliers UI (statica)"},
  {"step":377,"scope":"procurement-ui-suppliers-connect","context":"Pagină Suppliers creată (pas 376).","task":"Integrează pagina de furnizori cu API-ul: la montare, face fetch **GET /suppliers** și populează tabelul; implementează formular (dialog) pentru crearea de furnizor nou (**POST /suppliers**) și reîmprospătează lista la succes.","dirs":["/standalone/mercantiq/apps/procurement/frontend/src/"],"constraints":"Utilizează React Query pentru fetch/cache; validează câmpuri înainte de POST.","output":"Suppliers list populată (dinamic)"},
  {"step":378,"scope":"procurement-ui-rfqs-static","context":"Module UI Procurement existent.","task":"Creează pagina `RFQsPage` cu tabelul de RFQ-uri: coloane (ID, Descriere, Status, Termen, Furnizor_sugerat) și buton 'New RFQ'.","dirs":["/standalone/mercantiq/apps/procurement/frontend/src/pages/"],"constraints":"MUI DataGrid; afișează status cu badge colorat (Tailwind).","output":"pagina RFQs UI (statica)"},
  {"step":379,"scope":"procurement-ui-rfqs-connect","context":"Pagină RFQs statică (pas 378).","task":"Conectează pagina RFQ la backend: fetch **GET /rfqs** (poate include parametri de filtrare ex. status) și populează tabelul; implementează butonul 'New RFQ' pentru a deschide formularul de creare RFQ.","dirs":["/standalone/mercantiq/apps/procurement/frontend/src/pages/"],"constraints":"Afișează și coloana Furnizor_sugerat dacă există (ex. numele furnizorului sugerat via AI).","output":"lista RFQ dinamică (din API)"},
  {"step":380,"scope":"procurement-ui-rfq-form-static","context":"Formular creare RFQ necesar.","task":"Creează componenta `RFQForm` (dialog/modal) pentru introducerea datelor unui RFQ nou: câmpuri pentru detalii cerere (titlu, termen limită) și linii (produse, cantități, unități).","dirs":["/standalone/mercantiq/apps/procurement/frontend/src/components/"],"constraints":"Folosește MUI Dialog și TextField; permite adăugare/ștergere linie; fără conexiune încă la backend.","output":"formular RFQ UI (statica)"},
  {"step":381,"scope":"procurement-ui-rfq-form-submit","context":"Form RFQ creat (pas 380).","task":"Implementează logica de trimitere în RFQForm: la confirmare, apelează API **POST /rfqs** cu datele colectate (inclusiv liniile) și închide formularul; actualizează lista RFQ-uri după creare.","dirs":["/standalone/mercantiq/apps/procurement/frontend/src/components/"],"constraints":"Validare client-side înainte de POST (toate câmpurile obligatorii completate); tratează erorile API (ex. 400 Bad Request).","output":"creare RFQ funcțională (UI+API)"},
  {"step":382,"scope":"procurement-ui-rfq-detail-static","context":"Vizualizare detalii RFQ necesară.","task":"Creează pagina `RFQDetailPage` cu afișarea informațiilor unui RFQ selectat: detalii RFQ (ID, descriere, status, deadline), tabel oferte primite (inițial gol) și acțiuni (ex. Accept Quote).","dirs":["/standalone/mercantiq/apps/procurement/frontend/src/pages/"],"constraints":"Include secțiunea 'Quotes' (MUI DataGrid) cu col. furnizor, valoare, status (ex. recommended/accepted).","output":"pagina detalii RFQ UI (statica)"},
  {"step":383,"scope":"procurement-ui-rfq-detail-connect","context":"Pagină detalii RFQ creată (pas 382).","task":"Conectează `RFQDetailPage` la backend: la încărcare, face **GET /rfqs/{id}** (inclusiv ofertele) și afișează datele; dacă există `suggested_supplier` (AI), marchează-l distinct (ex. italic sau badge).","dirs":["/standalone/mercantiq/apps/procurement/frontend/src/pages/"],"constraints":"Folosește `useEffect` pentru fetch; asigură refresh după adăugare/acceptare ofertă (ex. prin refetch on close dialog).","output":"detalii RFQ dinamice (cu oferte)"},
  {"step":384,"scope":"procurement-ui-add-quote-static","context":"Ofertele introduse manual pe RFQ.","task":"Creează componenta `AddQuoteForm` (dialog) pentru a adăuga o ofertă: selectează furnizor (dropdown cu lista furnizorilor existenți) și introduce valoarea ofertei, termenul de valabilitate (zile).","dirs":["/standalone/mercantiq/apps/procurement/frontend/src/components/"],"constraints":"Folosește MUI Select pentru furnizor; valorile necesare (preț, valabilitate) trebuie să fie pozitive.","output":"formular ofertă UI (statica)"},
  {"step":385,"scope":"procurement-ui-add-quote-submit","context":"Form ofertă creat (pas 384).","task":"Conectează `AddQuoteForm` la backend: la submit trimite **POST /rfqs/{id}/quotes** cu datele introduse; actualizează lista de oferte din `RFQDetailPage` la succes (include noua ofertă).","dirs":["/standalone/mercantiq/apps/procurement/frontend/src/components/"],"constraints":"Butonul Submit dezactivat până la completarea tuturor câmpurilor; tratează erorile de la API (ex. ofertă duplicat -> mesaj).","output":"adăugare ofertă funcțională (UI+API)"},
  {"step":386,"scope":"procurement-ui-accept-quote-action","context":"Oferte disponibile în RFQDetailPage.","task":"Implementează acțiunea 'Accept Quote' în UI: un buton per ofertă listată care, la click, cere confirmare utilizatorului și apoi apelează API **POST /rfqs/{id}/accept** cu ID-ul ofertei alese; la succes, navighează la pagina PO generat.","dirs":["/standalone/mercantiq/apps/procurement/frontend/src/pages/"],"constraints":"Popup de confirmare înainte de acceptare; dezactivează butonul după click până la răspuns; tratează cazul de eroare (ex. 409 dacă altcineva a închis RFQ-ul).","output":"acceptare ofertă din UI (creează PO)"},
  {"step":387,"scope":"procurement-ui-po-list-static","context":"UI pentru comenzi P2P.","task":"Creează pagina `PurchaseOrdersPage` cu tabelul comenzilor de achiziție: coloane (ID, Furnizor, Data, Status, Total) și filtru după Status (dropdown Pending/Approved/Received).","dirs":["/standalone/mercantiq/apps/procurement/frontend/src/pages/"],"constraints":"Folosește MUI DataGrid; formatează Data în format local (utilizează `toLocaleDateString`).","output":"pagina PO list UI (statica)"},
  {"step":388,"scope":"procurement-ui-po-list-connect","context":"Pagină PO list creată (pas 387).","task":"Conectează `PurchaseOrdersPage` la backend: fetch **GET /purchase-orders** (poate filtra după status dacă selectat) și populează tabelul; oprește indicatorul de încărcare după răspuns.","dirs":["/standalone/mercantiq/apps/procurement/frontend/src/pages/"],"constraints":"Refresh automat al listei după aprobări sau recepții (ex. re-fetch periodic sau la focus).","output":"listă PO dinamică (din API)"},
  {"step":389,"scope":"procurement-ui-po-detail-static","context":"Vizualizare detalii PO necesară.","task":"Creează pagina `PODetailPage` care afișează detaliile unei comenzi: informații generale (furnizor, status, total), tabel linii comandă (produs, cantitate, preț unitar), secțiune recepție (cantitate recepționată) și secțiune factură (număr, sumă).","dirs":["/standalone/mercantiq/apps/procurement/frontend/src/pages/"],"constraints":"Afișează status vizual (ex. badge verde pentru Approved, albastru pentru Received); prevede spațiu pentru link PDF (dacă există).","output":"pagina detalii PO UI (statica)"},
  {"step":390,"scope":"procurement-ui-po-detail-connect","context":"Pagină detalii PO creată (pas 389).","task":"Conectează `PODetailPage` la backend: la montare face **GET /purchase-orders/{id}** și afișează datele (inclusiv linii, GRN și invoice dacă există); dacă există PDF (link în câmpul PO), oferă buton de descărcare.","dirs":["/standalone/mercantiq/apps/procurement/frontend/src/pages/"],"constraints":"Protejează link-ul PDF (necesită autentificare la download); actualizează UI dacă statusul se modifică (ex. după aprobare).","output":"detalii PO dinamice (cu recepție, factură)"},
  {"step":391,"scope":"procurement-ui-approve-po-button","context":"Pagina detalii PO încărcată (pas 390).","task":"Adaugă pe `PODetailPage` butonul **'Approve'** dacă statusul PO este PENDING: la click, apelează API **PATCH /purchase-orders/{id}/approve**, apoi actualizează statusul în UI la APPROVED.","dirs":["/standalone/mercantiq/apps/procurement/frontend/src/pages/"],"constraints":"Buton vizibil doar pentru utilizatori cu rol potrivit; dialog 'Confirm approve?' înainte de acțiune.","output":"aprobarea PO din UI"},
  {"step":392,"scope":"procurement-ui-invoice-form-static","context":"Înregistrare factură de la furnizor necesară în UI.","task":"Creează componenta `InvoiceForm` (dialog) ce permite introducerea detaliilor facturii: număr factură, dată, sumă (valuta implicită).","dirs":["/standalone/mercantiq/apps/procurement/frontend/src/components/"],"constraints":"MUI Dialog cu TextField-uri; sumă numerică cu 2 zecimale; dată cu DatePicker (ex. MUI X).","output":"formular factură UI (statica)"},
  {"step":393,"scope":"procurement-ui-invoice-form-submit","context":"Formular factură creat (pas 392).","task":"Conectează `InvoiceForm` la backend: la submit, trimite **POST /purchase-orders/{id}/invoice** cu datele completate; închide dialogul și actualizează secțiunea de factură din `PODetailPage` (număr, sumă, status 3WM).","dirs":["/standalone/mercantiq/apps/procurement/frontend/src/components/"],"constraints":"Blochează Submit până la completarea câmpurilor obligatorii; formatează data în format ISO pentru API.","output":"înregistrare factură din UI (funcțional)"},
  {"step":394,"scope":"procurement-ui-3wm-indicator","context":"Detalii PO afișate în UI (pas 390).","task":"Afișează în `PODetailPage` statusul **3-Way Match** odată ce atât recepția cât și factura sunt prezente: dacă discrepanța > 2%, evidențiază cu indicator roșu 'Mismatch', altfel verde 'Matched'.","dirs":["/standalone/mercantiq/apps/procurement/frontend/src/pages/"],"constraints":"Calculează diferența relativă între total PO și sumă factură; actualizează indicatorul la schimbarea datelor (ex. la înregistrare factură).","output":"indicator 3WM UI (corect)"},
  {"step":395,"scope":"procurement-ui-suggestion","context":"Recomandare AI furnizor stocată (pas 371).","task":"În `RFQDetailPage`, dacă RFQ are un `suggested_supplier_id` (de la AI), afișează un banner sau text evidențiind furnizorul sugerat (ex: 'Recomandat: ABC Corp') pentru utilizator.","dirs":["/standalone/mercantiq/apps/procurement/frontend/src/pages/"],"constraints":"Stilizare distinctă (ex. italic, culoare); nu auto-selectează furnizorul – doar informativ.","output":"vizualizare sugestie AI furnizor"},
  {"step":396,"scope":"procurement-ui-tests-pages","context":"Funcționalități UI implementate.","task":"Scrie teste unitare cu React Testing Library pentru componentele principale: verifică că `SuppliersPage` afișează lista de furnizori, `RFQsPage` afișează RFQ-urile corect (mock fetch API).","dirs":["/standalone/mercantiq/apps/procurement/frontend/src/"],"constraints":"Coverage minim 80%; folosește `jest.mock` pentru fetch API și servicii externe.","output":"teste unitare UI trecute"},
  {"step":397,"scope":"procurement-ui-tests-po","context":"PODetailPage cu logică complexă.","task":"Scrie test pentru `PODetailPage`: simulează scenariu cu PO complet (cu recepție și factură) și verifică afișarea corectă a informațiilor, inclusiv indicatorul 3WM (OK vs FLAGGED).","dirs":["/standalone/mercantiq/apps/procurement/frontend/src/"],"constraints":"Utilizează date mock pentru PO și Invoice; asigură că indicatorul 3WM este conform datelor (ex. FLAGGED la discrepanță > 2%).","output":"test UI PO detalii reușit"},
  {"step":398,"scope":"procurement-e2e-p2p","context":"Test integrat flux complet.","task":"Dezvoltă test end-to-end (Playwright) care parcurge fluxul complet Procure-to-Pay: creează un RFQ, adaugă ofertă, acceptă oferta (creează PO), aprobă PO, simulează recepție (apel intern) și înregistrează factura, verificând la final că PO are status final și 3WM calculat.","dirs":["/standalone/mercantiq/tests/e2e/"],"constraints":"Rulează testul pe environment de dev cu date seed; timp total < 2 min; cleanup după rulare.","output":"E2E P2P reușit (automat)"},
  {"step":399,"scope":"procurement-api-tests","context":"Teste unitare servicii.","task":"Scrie teste unitare (Jest) pentru serviciile RFQ și PO: includ scenarii de succes și eroare (ex. ofertă duplicat, aprobare PO fără linii) pentru a asigura acoperirea logicii.","dirs":["/standalone/mercantiq/apps/procurement/api/src/services/"],"constraints":"Coverage ≥ 90% pe metode critice; mocează repository-urile (folosind `jest.mock`).","output":"teste servicii verzi"},
  {"step":400,"scope":"procurement-security-authz","context":"Endpoint-urile Procurement implementate.","task":"Aplică guard-ul de autorizare JWT la toate rutele modulului Procurement: doar userii cu scope `procurement:*` pot accesa API-ul; verifică claim-urile de rol la endpoints sensibile (ex. approve PO).","dirs":["/standalone/mercantiq/apps/procurement/api/src/controllers/"],"constraints":"Folosește JwtAuthGuard global definit; test manual cu token fără scope -> 403.","output":"autorizare API asigurată (JWT/role)"},
  {"step":401,"scope":"procurement-security-test","context":"Guard JWT aplicat (pas 400).","task":"Adaugă un test integrat de securitate: încearcă accesarea unui endpoint Procurement fără token JWT valid sau cu scope greșit și verifică răspunsul 401/403 corespunzător.","dirs":["/standalone/mercantiq/tests/integration/"],"constraints":"Include în pipeline CI; asigură că testul eșuează dacă protecția lipsește.","output":"test acces neautorizat OK"},
  {"step":402,"scope":"procurement-observability-otel","context":"Trase observabilitate lipsă pe modul nou.","task":"Activează OpenTelemetry tracing în serviciul NestJS Procurement: configurează un modul sau interceptor global astfel încât toate request-urile Procurement API să emită trace-uri (service.name = procurement-api) colectate în Tempo.","dirs":["/standalone/mercantiq/apps/procurement/api/src/"],"constraints":"Folosește setările globale OTel din core; nu afectează performanța vizibil (sampling optim).","output":"traces API Procurement vizibile"},
  {"step":403,"scope":"procurement-observability-metrics","context":"Expunere metrici lipsă pe modul nou.","task":"Integrează un middleware de metrice Prometheus în Procurement API (ex. `@willsoto/nestjs-prometheus`): expune metrici HTTP (durata requests, număr requests, etc.) la endpoint-ul **/metrics** pentru scraping.","dirs":["/standalone/mercantiq/apps/procurement/api/src/"],"constraints":"Asigură prefixare metrici cu `procurement_`; exclude date sensibile.","output":"metrici API expuse (Prometheus)"},
  {"step":404,"scope":"procurement-performance","context":"KPI performanță F2 (p95 < 250ms).","task":"Evaluează performanța API-ului Procurement sub încărcare: rulează un test K6 cu 50 RPS pentru crearea de RFQ și aprobare PO, verificând că latența p95 este sub 250ms.","dirs":["/standalone/mercantiq/tests/k6/"],"constraints":"Include testul în Grafana (dashboard P2P) cu grafic de latență; optimizează query-urile dacă pragul este depășit.","output":"raport performanță OK (p95)"},
  {"step":405,"scope":"procurement-docker-api","context":"Deployment containere necesar.","task":"Creează Dockerfile pentru serviciul API Procurement (Node 20 + NestJS build multi-stage): build al aplicației, apoi imagine runtime minimală (alpine) cu variabile (DB URL, etc.).","dirs":["/standalone/mercantiq/"],"constraints":"Utilizează user non-root; expune port conform .env; stage build separate; optimizează dimensiunea imaginii.","output":"Dockerfile API Procurement"},
  {"step":406,"scope":"procurement-docker-frontend","context":"Deployment containere necesar.","task":"Creează Dockerfile pentru frontend-ul Procurement (React): build de producție (vite build) apoi servește staticele cu nginx sau `serve`-lite.","dirs":["/standalone/mercantiq/"],"constraints":"Dimensiune optimizată (<100MB imagine); config nginx cu header-e de securitate de bază.","output":"Dockerfile UI Procurement"},
  {"step":407,"scope":"procurement-helm-chart","context":"Containerizare completă (pas 405–406).","task":"Adaugă chart Helm pentru modul Procurement: Deployment-uri Kubernetes pentru api și frontend, Service pentru API, IngressRoute Traefik cu host/path dedicat (ex. `/procurement/*`), și ServiceMonitor pentru metrici.","dirs":["/standalone/mercantiq/infra/helm/"],"constraints":"Include valori separate dev/prod; imagini semnate (cosign); testează upgrade chart local.","output":"chart Helm Procurement"},
  {"step":408,"scope":"procurement-argocd","context":"Chart Helm disponibil (pas 407).","task":"Configurează Argo CD cu canary deployment pentru Procurement: Argo Rollouts pentru P2P APIs, traffic split 10%→40%→100%, analysis cu P2P metrics (3-way match accuracy > 98%, PO approval latency < 4h), automated rollback pe procurement errors.","dirs":["/core/infra/k8s/argocd/","/standalone/mercantiq/apps/procurement/infra/k8s/argo-rollouts/"],"constraints":"P2P stability critical; supplier relationship protection; automated rollback; cosign verify obligatoriu","output":"Procurement canary deployment P2P-grade"},
  {"step":409,"scope":"procurement-bus-spec","context":"Evenimente modul Procurement (pas 366–369).","task":"Actualizează documentația `docs/event-bus/v1-spec.md` pentru a include definițiile evenimentelor Procurement (`procurement.rfq.created`, `procurement.po.approved`, etc.), cu payload și exemple.","dirs":["/core/docs/event-bus/"],"constraints":"Respectă formatul tabelar existent (Topic, Payload, Description); PR revizuit de arhitect.","output":"spec event-bus actualizat (Procurement)"},
  {"step":410,"scope":"procurement-postman","context":"Colecții Postman lipsesc pentru modul nou.","task":"Adaugă colecția Postman **Procurement API** cu request-uri pentru toate endpoint-urile implementate (Suppliers, RFQs, Quotes, PO, Invoice) și exemple de răspuns. Include environment de dev (URL, token sample).","dirs":["/core/docs/postman/"],"constraints":"Folosește nomenclatură consistentă; documentează precondiții (ex. trebuie creat supplier înainte de RFQ).","output":"colecție Postman Procurement"},
  {"step":411,"scope":"procurement-contract-tests","context":"Evenimente inter-modulare Procurement definitivate.","task":"Dezvoltă contract tests (Pact) pentru evenimentele Procurement: ex. modul iWMS ca consumer confirmă că `procurement.po.approved` conține câmpurile așteptate; modul Procurement ca consumer confirmă formatul `wms.grn.posted`.","dirs":["/core/tests/contract/event-bus/"],"constraints":"Include pacts pentru fiecare pereche modul publisher/consumer relevant; coverage ≥ 90%.","output":"contract tests event-bus (verzi)"},
  {"step":412,"scope":"procurement-ci-pipeline","context":"Workflow CI existent (module-ci).","task":"Implementează CI/CD complet pentru Procurement folosind template F0: Trivy scans cu praguri standardizate CRITICAL=0, HIGH≤3, MEDIUM≤15, SAST analysis pentru supplier data, financial compliance scanning, 3-way match validation, SBOM generation, Cosign signing.","dirs":["/.github/workflows/"],"constraints":"supplier data security critical; financial compliance; fail on CRITICAL; codecov 80%; audit trail; conform standard global","output":"CI/CD Procurement securizat cu praguri standardizate"},
  {"step":413,"scope":"procurement-kpi-dashboard","context":"Dashboards Grafana F2 (O2C, P2P).","task":"Configurează panoul dedicat în Grafana pentru fluxul Procure-to-Pay: afișează număr RFQ deschise, rata de conversie RFQ->PO, timp mediu de aprobare PO, latența medie API, și grafic de evenimente (procurement.*) în timp real.","dirs":["/core/infra/grafana/provisioning/dashboards/"],"constraints":"UID unic 'dashboard_p2p'; folosește date din Prometheus și Loki (log event count).","output":"dashboard Grafana P2P"},
  {"step":414,"scope":"procurement-alerts","context":"Reguli Alertmanager F2 (pas 353).","task":"Adaugă alerte specifice pentru modul Procurement: ex. dacă un RFQ rămâne OPEN > 14 zile (indicativ lipsă oferte) sau dacă un PO APPROVED nu are recepție > 7 zile. Notifică echipa pe Slack (via `notify.slack`).","dirs":["/core/infra/k8s/alertmanager/rules/"],"constraints":"Se integrează în grupul de reguli existent (F2); severitate warning; testează scenariu manual.","output":"alerte Procurement adăugate"},
  {"step":415,"scope":"procurement-audit-logs","context":"Cerințe audit Security.","task":"Activează audit trail pentru acțiunile critice din modul Procurement: loghează în tabelul de audit (sau Log) cine și când a aprobat un PO, a înregistrat o recepție sau a modificat o factură. Oferă opțiune de export în CSV semnat.","dirs":["/standalone/mercantiq/apps/procurement/api/src/"],"constraints":"Integrează semnătură digitală la export (cosign); log-urile conțin `tid`, user id, timestamp, acțiune.","output":"audit trail Procurement (loguri securizate)"},
  {"step":416,"scope":"procurement-handover","context":"Gate F2 atins pentru Procurement.","task":"Pregătește documentația de predare F2 pentru modul Procurement: descrie configurațiile deployment (URL, namespace), link la dashboard-ul P2P, exemplu de trace Tempo pentru un flux complet, și checklist de testare finală.","dirs":["/core/docs/handovers/"],"constraints":"Include capturi Grafana/Tempo; aprobare de arhitect înainte de livrare.","output":"document handover F2 Procurement"},
  
  // 📊 OBSERVABILITATE PROCUREMENT (417-423)
  {"step":417,"scope":"procurement-dashboard-p2p-advanced","context":"P2P dashboard avansat lipsește.","task":"Creează dashboard Grafana avansat pentru Procure-to-Pay: supplier performance metrics, 3-way match accuracy, PO approval workflows, invoice processing times, cost savings tracking.","dirs":["/infra/grafana/provisioning/dashboards/"],"constraints":"UID procurement_p2p_advanced; supplier analytics; cost optimization focus","output":"dashboard Procurement P2P Advanced"},
  {"step":418,"scope":"procurement-dashboard-supplier-analytics","context":"Supplier analytics dashboard lipsește.","task":"Creează dashboard pentru supplier analytics: supplier reliability scores, delivery performance, quality metrics, cost comparison analysis, payment terms compliance.","dirs":["/infra/grafana/provisioning/dashboards/"],"constraints":"UID procurement_supplier_analytics; vendor management focus; performance trends","output":"dashboard Procurement Supplier Analytics"},
  {"step":419,"scope":"procurement-alerts-3way-match","context":"3-way match alerts specifice lipsesc.","task":"Configurează alerte 3-way match: alert pentru discrepanțe > 2%, alert pentru PO fără recepție > 7 zile, alert pentru facturi fără PO matching, alert pentru aprovals în așteptare > 48h.","dirs":["/infra/k8s/alertmanager/rules/"],"constraints":"financial accuracy critical; escalation to procurement team; include discrepancy details","output":"alerte Procurement 3-Way Match"},
  {"step":420,"scope":"procurement-alerts-supplier-performance","context":"Supplier performance alerts lipsesc.","task":"Configurează alerte supplier performance: alert pentru late deliveries > 20%, alert pentru quality issues > 10%, alert pentru payment delays > 30 days, alert pentru new supplier onboarding delays.","dirs":["/infra/k8s/alertmanager/rules/"],"constraints":"vendor management critical; include performance metrics; escalation matrix","output":"alerte Procurement Supplier Performance"},
  {"step":421,"scope":"procurement-metrics-cost-analytics","context":"Cost analytics metrics detaliate lipsesc.","task":"Adaugă metrici cost analytics pentru Procurement: spend per category, cost savings per supplier, budget variance tracking, ROI per purchase order, negotiation effectiveness metrics.","dirs":["/standalone/mercantiq/apps/procurement/api/src/metrics/"],"constraints":"financial accuracy; audit compliance; privacy protection","output":"metrici Procurement Cost Analytics"},
  {"step":422,"scope":"procurement-slo-p2p","context":"SLO pentru P2P process lipsesc.","task":"Definește SLO pentru Procurement P2P: RFQ response time < 24h (SLO 95%), PO approval < 4h (SLO 90%), invoice processing < 48h (SLO 85%), 3-way match accuracy > 98%.","dirs":["/infra/grafana/provisioning/dashboards/","/infra/k8s/alertmanager/rules/"],"constraints":"procurement efficiency SLOs; error budget tracking; business impact focus","output":"SLO Procurement P2P definite"},
  {"step":423,"scope":"procurement-dashboard-iwms-integration","context":"iWMS integration monitoring lipsește.","task":"Creează dashboard pentru integrarea Procurement-iWMS: GRN sync success rates, inventory update accuracy, receival processing latency, stock reconciliation status, warehouse performance metrics.","dirs":["/infra/grafana/provisioning/dashboards/"],"constraints":"UID procurement_iwms_integration; logistics focus; real-time warehouse status","output":"dashboard Procurement-iWMS Integration"},
  
  // 🔐 CI/CD PROCUREMENT SECURITATE P2P (424-428)
  {"step":424,"scope":"procurement-vulnerability-scanning-p2p","context":"P2P-specific vulnerability scanning lipsește.","task":"Implementează scanning P2P pentru Procurement: supplier data security validation, financial compliance scanning, 3-way match algorithm security, vendor API security validation.","dirs":["/standalone/mercantiq/apps/procurement/","/infra/k8s/trivy/"],"constraints":"supplier data protection critical; financial compliance; vendor security validation; regular audits","output":"Procurement P2P vulnerability scanning"},
  {"step":425,"scope":"procurement-canary-p2p-metrics","context":"Canary deployment cu P2P metrics lipsește.","task":"Configurează canary analysis pentru Procurement cu P2P metrics: 3-way match accuracy monitoring, supplier approval workflow tracking, PO processing performance, financial reconciliation validation.","dirs":["/standalone/mercantiq/apps/procurement/infra/k8s/argo-rollouts/"],"constraints":"P2P accuracy critical; supplier relationship protection; financial integrity; conservative rollout","output":"Procurement canary P2P metrics"},
  {"step":426,"scope":"procurement-rollback-p2p-protection","context":"Rollback protection pentru P2P data lipsește.","task":"Implementează rollback protection pentru P2P data: supplier data integrity, PO transaction consistency, 3-way match preservation, vendor relationship continuity validation.","dirs":["/standalone/mercantiq/apps/procurement/infra/k8s/","/standalone/mercantiq/apps/procurement/scripts/"],"constraints":"supplier data integrity critical; PO consistency; vendor relationship protection; audit trail","output":"Procurement P2P rollback protection"},
  {"step":427,"scope":"procurement-health-checks-p2p","context":"Health checks P2P specifice lipsesc.","task":"Implementează health checks P2P pentru Procurement: supplier API connectivity, 3-way match system health, PO approval workflow status, financial integration validation.","dirs":["/standalone/mercantiq/apps/procurement/api/src/health/","/infra/k8s/health-checks/"],"constraints":"P2P health validation; supplier connectivity; financial system dependency; workflow integrity","output":"Procurement P2P health checks"},
  {"step":428,"scope":"procurement-deployment-p2p-validation","context":"Deployment validation pentru P2P business logic lipsește.","task":"Adaugă deployment validation pentru P2P logic: 3-way match algorithm verification, supplier approval workflow testing, PO calculation validation, financial reconciliation accuracy checks.","dirs":["/standalone/mercantiq/apps/procurement/tests/deployment/","/standalone/mercantiq/apps/procurement/scripts/validation/"],"constraints":"P2P accuracy critical; supplier workflow validation; financial reconciliation testing; automated validation","output":"Procurement P2P deployment validation"}
]
```

---

### Note & aliniere la documentația suitei

* **Event‑Bus & convenții v1:** nume evenimente `module.ctx.event` (ex.: `procurement.rfq.created`, `procurement.po.approved`, `procurement.3wm.flagged`).
* **Stack & căi canonice:** UI/API pe stack fix, proiecte sub `standalone/mercantiq/...` (lint‑paths blochează `apps/...`).
* **Workeri disponibili & Registry:** `match.ai`, `pdf.render`, `email.send`, `notify.slack`, `ai.classify`, `forecast` cu health & traces vizibile prin Worker Registry/Tempo.
* **Date & securitate:** multitenancy pe PG/MinIO/Redis, RLS pe `tid/whid`, SSE‑C pe MinIO, JWT RS256 cu claims standard.
* **Observabilitate:** Prometheus metrics, Loki logs, Tempo traces, dashboards SLO, alerte queue lag/erroare.
* **Gate F2 ➜ F3:** P2P < 3 min, O2C complet, SLO p95 < 250 ms, erori < 1 %.

> Această versiune implementează **logica stand‑alone** a aplicației Mercantiq Procurement și integrează **bi‑direcțional** cu suita (iWMS, Sales, Accounting), extinzând capabilitățile de automatizare AI (match.ai pentru sugestii furnizori), workflow‑uri de aprobare și Three‑Way Match automat – aliniat cu principiile și standardele tehnice ale GeniusERP Suite.

## 9) Note de implementare

* **Căi canonice & arbore directoare**: folosește exact structura indicată pentru standalone apps (`standalone/mercantiq/apps/procurement/`); nu devia la `/apps` fără prefix `standalone/`.
* **Evenimente & naming**: menține convențiile v1 și validează în CI cu `lint-rmq.sh`. Format: `procurement.rfq.created`, `procurement.po.approved`, `procurement.3wm.flagged`.
* **Workeri**: integrează‑te cu workers existenți (match.ai, pdf.render) fără a schimba stack‑ul lor (Python 3.13 + Celery).
* **Multitenancy/RLS**: izolare strictă `tid/whid/mid` conform modelului de date Fazei F2.
* **Three‑Way Match**: implementarea automată trebuie să detecteze discrepanțe >2% și să emită alerte corespunzătoare.
* **Procure‑to‑Pay**: fluxul complet trebuie validat E2E cu toate evenimentele în succesiune.
* **AI Integration**: integrarea cu worker‑ul `match.ai` pentru sugestii furnizori este obligatorie.
* **iWMS Integration**: sincronizarea cu evenimente de recepție din iWMS pentru completarea GRN.
* **CI/CD**: Trivy HIGH, cosign sign/attest, Argo sync, canary + rollback metric‑based conform umbrele F2.
* **Observabilitate**: traces end‑to‑end, metrics per‑tenant, dashboards P2P, alerte pentru RFQ stagnante și PO fără recepție.

---

## 10) Dependențe externe și API keys

Pentru funcționarea completă a integrărilor, sunt necesare următoarele configurații via ExternalSecrets:

* **SMTP**: configurare server pentru notificări furnizori și echipe interne
* **Slack/Teams**: webhook URL pentru notificări aprobare și alerte 3WM
* **AI Services**: configurări pentru worker‑ul `match.ai` (dacă necesare API keys externe)
* **iWMS Integration**: configurații endpoint‑uri pentru sincronizarea recepțiilor
* **PDF Templates**: configurări branding per tenant pentru generare comenzi
* **Database**: credențiale PostgreSQL per tenant pentru RLS și izolare date

Toate acestea trebuie configurate prin Kubernetes ExternalSecrets, nu hardcodate în aplicație.

---

> Această versiune implementează **Mercantiq Procurement** ca modulul central pentru fluxul Procure‑to‑Pay cu integrări profunde AI, automatizare Three‑Way Match și interoperabilitate maximă cu suita GeniusERP, respectând totodată principiile de securitate, observabilitate și scalabilitate ale platformei.

